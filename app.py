import streamlit as st
import pandas as pd

# р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ъ
st.set_page_config(page_title="Order Dashboard", layout="wide")
st.title("ЁЯУК р╕гр╕░р╕Ър╕Ър╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н (Seller Conversion)")

# 1. р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕е
@st.cache_data
def load_data():
    # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Кр╕╖р╣Ир╕нр╣Др╕Яр╕ер╣Мр╣Гр╕лр╣Йр╕Хр╕гр╕Зр╕Бр╕▒р╕Ър╕Чр╕╡р╣Ир╕Др╕╕р╕Ур╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф
    file_name = 'SellerConversionReport_202601171834.csv'
    df = pd.read_csv(file_name)
    # р╣Бр╕Ыр╕ер╕Зр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Гр╕лр╣Йр╣Ар╕Ыр╣Зр╕Щ datetime
    df['р╣Ар╕зр╕ер╕▓р╕Чр╕╡р╣Ир╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н'] = pd.to_datetime(df['р╣Ар╕зр╕ер╕▓р╕Чр╕╡р╣Ир╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н'])
    return df

try:
    df = load_data()

    # 2. Sidebar Filters (р╕кр╣Ир╕зр╕Щр╕Хр╕▒р╕зр╕Бр╕гр╕нр╕З)
    st.sidebar.header("р╕Хр╕▒р╕зр╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е")
    
    # р╕Хр╕▒р╕зр╕Бр╕гр╕нр╕З 1: р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н
    status_filter = st.sidebar.multiselect(
        "р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н", 
        options=df['р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н'].unique(), 
        default=df['р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н'].unique()
    )

    # р╕Хр╕▒р╕зр╕Бр╕гр╕нр╕З 2: р╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╕вр╕╖р╕Щр╕вр╕▒р╕Щ (р╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Вр╣Йр╕▓р╕бр╕▓р╣Гр╕лр╕бр╣И тнР)
    confirm_filter = st.sidebar.multiselect(
        "р╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╕вр╕╖р╕Щр╕вр╕▒р╕Щ", 
        options=df['р╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╕вр╕╖р╕Щр╕вр╕▒р╕Щ'].unique(), 
        default=df['р╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╕вр╕╖р╕Щр╕вр╕▒р╕Щ'].unique()
    )

    # р╕Хр╕▒р╕зр╕Бр╕гр╕нр╕З 3: р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕кр╕┤р╕Щр╕Др╣Йр╕▓
    category_filter = st.sidebar.multiselect(
        "р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕кр╕┤р╕Щр╕Др╣Йр╕▓", 
        options=df['L1 р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕кр╕▓р╕Бр╕е'].unique(), 
        default=df['L1 р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕кр╕▓р╕Бр╕е'].unique()
    )
    
    # --- р╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Хр╕▓р╕бр╕Чр╕╡р╣Ир╣Ар╕ер╕╖р╕нр╕Бр╕Чр╕▒р╣Йр╕З 3 р╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕В ---
    mask = (
        df['р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н'].isin(status_filter) & 
        df['р╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╕вр╕╖р╕Щр╕вр╕▒р╕Щ'].isin(confirm_filter) & 
        df['L1 р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕кр╕▓р╕Бр╕е'].isin(category_filter)
    )
    filtered_df = df[mask]

    # 3. р╣Бр╕кр╕Фр╕Зр╕кр╕гр╕╕р╕Ыр╕Ьр╕е (KPIs)
    col1, col2, col3 = st.columns(3)
    with col1:
        st.metric("р╕вр╕нр╕Фр╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕нр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф", f"{filtered_df['р╕бр╕╣р╕ер╕Др╣Ир╕▓р╕Чр╕╡р╣Ир╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н(р╕┐)'].sum():,.2f} р╕┐")
    with col2:
        st.metric("р╕Ир╕│р╕Щр╕зр╕Щ Order", f"{len(filtered_df)} р╕гр╕▓р╕вр╕Бр╕▓р╕г")
    with col3:
        st.metric("р╕Др╣Ир╕▓р╕Др╕нр╕бр╕бр╕┤р╕Кр╕Кр╕▒р╣Ир╕Щр╕гр╕зр╕б", f"{filtered_df['р╕Др╕нр╕бр╕бр╕┤р╕Кр╕Кр╕▒р╣Ир╕Щр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Ир╕▓р╕Бр╕Ьр╕╣р╣Йр╕Вр╕▓р╕в(р╕┐)'].sum():,.2f} р╕┐")

    # 4. р╣Бр╕кр╕Фр╕Зр╕Хр╕▓р╕гр╕▓р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е
