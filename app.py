import streamlit as st
import pandas as pd

# р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ъ
st.set_page_config(page_title="Order Dashboard", layout="wide")
st.title("ЁЯУК р╕гр╕░р╕Ър╕Ър╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н (Seller Conversion)")

# 1. р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕е
@st.cache_data
def load_data():
    df = pd.read_csv('SellerConversionReport_202601171834.csv')
    # р╣Бр╕Ыр╕ер╕Зр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Гр╕лр╣Йр╣Ар╕Ыр╣Зр╕Щ datetime
    df['р╣Ар╕зр╕ер╕▓р╕Чр╕╡р╣Ир╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н'] = pd.to_datetime(df['р╣Ар╕зр╕ер╕▓р╕Чр╕╡р╣Ир╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н'])
    return df

try:
    df = load_data()

    # 2. Sidebar Filters
    st.sidebar.header("р╕Хр╕▒р╕зр╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е")
    status_filter = st.sidebar.multiselect("р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н", options=df['р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н'].unique(), default=df['р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н'].unique())
    category_filter = st.sidebar.multiselect("р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕кр╕┤р╕Щр╕Др╣Йр╕▓", options=df['L1 р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕кр╕▓р╕Бр╕е'].unique(), default=df['L1 р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕кр╕▓р╕Бр╕е'].unique())
    
    # р╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Хр╕▓р╕бр╕Чр╕╡р╣Ир╣Ар╕ер╕╖р╕нр╕Б
    filtered_df = df[(df['р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н'].isin(status_filter)) & (df['L1 р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕кр╕▓р╕Бр╕е'].isin(category_filter))]

    # 3. р╣Бр╕кр╕Фр╕Зр╕кр╕гр╕╕р╕Ыр╕Ьр╕е (KPIs)
    col1, col2, col3 = st.columns(3)
    col1.metric("р╕вр╕нр╕Фр╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕нр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф", f"{filtered_df['р╕бр╕╣р╕ер╕Др╣Ир╕▓р╕Чр╕╡р╣Ир╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н(р╕┐)'].sum():,.2f} р╕┐")
    col2.metric("р╕Ир╕│р╕Щр╕зр╕Щ Order", f"{len(filtered_df)} р╕гр╕▓р╕вр╕Бр╕▓р╕г")
    col3.metric("р╕Др╣Ир╕▓р╕Др╕нр╕бр╕бр╕┤р╕Кр╕Кр╕▒р╣Ир╕Щр╕гр╕зр╕б", f"{filtered_df['р╕Др╕нр╕бр╕бр╕┤р╕Кр╕Кр╕▒р╣Ир╕Щр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Ир╕▓р╕Бр╕Ьр╕╣р╣Йр╕Вр╕▓р╕в(р╕┐)'].sum():,.2f} р╕┐")

    # 4. р╣Бр╕кр╕Фр╕Зр╕Хр╕▓р╕гр╕▓р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е
    st.subheader("р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н")
    st.dataframe(filtered_df[['р╕гр╕лр╕▒р╕кр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н', 'р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н', 'р╕Кр╕╖р╣Ир╕нр╕кр╕┤р╕Щр╕Др╣Йр╕▓', 'р╕бр╕╣р╕ер╕Др╣Ир╕▓р╕Чр╕╡р╣Ир╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н(р╕┐)', 'р╣Ар╕зр╕ер╕▓р╕Чр╕╡р╣Ир╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н']], use_container_width=True)

except Exception as e:
    st.error(f"р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣М: {e}")
    st.info("р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕Кр╕╖р╣Ир╕нр╣Др╕Яр╕ер╣М CSV р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╣Бр╕ер╕░р╕нр╕вр╕╣р╣Ир╣Гр╕Щр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣Мр╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ")